---
params:
  subtitle: ""
  title: ""
  authors: ""
title: '`r params$title`'
subtitle: '`r params$subtitle`'
author: '`r params$authors`'
date: 'Last run at: `r Sys.time()`'
output:
  bookdown::html_document2:
    fig_caption: yes
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: TRUE
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: yes
  bookdown::word_document2:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
    fig_width: 5
always_allow_html: yes
bibliography: '`r paste0(here::here(), "/bibliography.bib")`'
---

```{r knitrSetup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo
```


```{r codeSetup, include=FALSE}
# Set start time ----
startTime <- proc.time()
# Local parameters ----
b2Kb <- 1024 #http://whatsabyte.com/P1/byteconverter.htm
b2Mb <- 1048576
plotLoc <- paste0(gcParams$repoLoc, "/docs/plots/") # where to put the plots

library(gridCarbon)
# Packages used in the report ----
rmdLibs <- c("ggplot2", # plots
             "hms",
          "kableExtra", # fancy tables
          "lubridate",
          "viridis"
          )
gridCarbon::loadLibraries(rmdLibs)

# Local parameters ----
localParams$lockDownStartDate <- as.Date("2020-03-24")
localParams$lockDownStartDateTime <- lubridate::as_datetime("2020-03-23 23:59:00")
localParams$lockDownEndDate <- lubridate::today()
localParams$lockDownEndDateTime <- lubridate::now()

localParams$recentCutDate <- as.Date("2020-03-01")

localParams$comparePlotCutDate <- as.Date("2020-02-01")

localParams$gamCap <- "Trend line = Generalized additive model (gam) with integrated smoothness estimation"
localParams$lockdownCap <- "\nColoured rectangle = UK covid lockdown to date"
localParams$weekendCap <- "\nShaded rectangle = weekends"

localParams$myAlpha <- 0.1
localParams$vLineAlpha <- 0.4
localParams$vLineCol <- "red" # http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/#a-colorblind-friendly-palette
localParams$myTextSize <- 4

# Local functions ----
addLockdownDate <- function(p, yMin, yMax){
  # assumes p has x = obsDate
  # p <- p + annotate("text", x = localParams$lockDownStartDate, 
  #            y = yMax * 0.4, angle = 10,size = localParams$myTextSize,
  #            label = "UK covid lockdown to date", hjust = 0.5)
  p <- p + annotate("rect", xmin = localParams$lockDownStartDate,
             xmax = localParams$lockDownEndDate, 
             ymin = yMin-1, ymax = yMax+1, 
             alpha = localParams$myAlpha, 
             fill = localParams$vLineCol, 
             colour = localParams$vLineCol)
  return(p)
}

addLockdownDateTime <- function(p, yMin, yMax){
  # assumes p has x = obsDateTime
  # p <- p + annotate("text", x = localParams$lockDownStartDateTime, 
  #            y = yMax * 0.4, angle = 10,size = localParams$myTextSize,
  #            label = "UK covid lockdown to date", hjust = 0.5)
  p <- p + annotate("rect", xmin = localParams$lockDownStartDateTime,
             xmax = localParams$lockDownEndDateTime, 
             ymin = yMin-1, ymax = yMax+1, 
             alpha = localParams$myAlpha, 
             fill = localParams$vLineCol, 
             colour = localParams$vLineCol) 
    
  return(p)
}

# only makes sense to use these for x axis covering March onwards
localParams$weAlpha <- 0.3
localParams$weFill <- "grey50"
localParams$labelPos <- 0.9
addWeekendsDate <- function(p, yMin, yMax){
  p <- p + annotate("rect", xmin = as.Date("2020-03-07"),
                    xmax = as.Date("2020-03-09"),
                    ymin = yMin, ymax = yMax,
                    alpha = localParams$weAlpha, fill = localParams$weFill)
  p <- p + annotate("rect", xmin = as.Date("2020-03-14"),
                    xmax = as.Date("2020-03-16"),
                    ymin = yMin, ymax = yMax,
                    alpha = localParams$weAlpha, fill = localParams$weFill)
  p <- p + annotate("rect", xmin = as.Date("2020-03-21"),
                    xmax = as.Date("2020-03-23"),
                    ymin = yMin, ymax = yMax,
                    alpha = localParams$weAlpha, fill = localParams$weFill)
  p <- p + annotate("rect", xmin = as.Date("2020-03-28"),
                    xmax = as.Date("2020-03-30"),
                    ymin = yMin, ymax = yMax,
                    alpha = localParams$weAlpha, fill = localParams$weFill)
  p <- p + annotate("rect", xmin = as.Date("2020-04-04"),
                    xmax = as.Date("2020-04-06"),
                    ymin = yMin, ymax = yMax,
                    alpha = localParams$weAlpha, fill = localParams$weFill)
  p <- p + annotate("rect", xmin = as.Date("2020-04-10"),
                    xmax = as.Date("2020-04-14"), # Easter
                    ymin = yMin, ymax = yMax,
                    alpha = localParams$weAlpha, fill = localParams$weFill)
  p <- p + annotate("text", x = as.Date("2020-04-10"),
                    y = yMax*localParams$labelPos,
                    label = "Easter") # Easter
  p <- p + annotate("rect", xmin = as.Date("2020-04-18"),
                    xmax = as.Date("2020-04-20"),
                    ymin = yMin, ymax = yMax,
                    alpha = localParams$weAlpha, fill = localParams$weFill)
  p <- p + annotate("rect", xmin = as.Date("2020-04-25"),
                    xmax = as.Date("2020-04-27"),
                    ymin = yMin, ymax = yMax,
                    alpha = localParams$weAlpha, fill = localParams$weFill)
  return(p)
}

addWeekendsDateTime <- function(p, yMin, yMax){
   p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-03-07 00:00:00"),
                    xmax = lubridate::as_datetime("2020-03-08 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = localParams$weAlpha, fill = localParams$weFill)
  p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-03-14 00:00:00"),
                    xmax = lubridate::as_datetime("2020-03-15 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = localParams$weAlpha, fill = localParams$weFill)
  p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-03-21 00:00:00"),
                    xmax = lubridate::as_datetime("2020-03-22 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = localParams$weAlpha, fill = localParams$weFill)
  p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-03-28 00:00:00"),
                    xmax = lubridate::as_datetime("2020-03-29 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = localParams$weAlpha, fill = localParams$weFill)
  p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-04-04 00:00:00"),
                    xmax = lubridate::as_datetime("2020-04-05 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = localParams$weAlpha, fill = localParams$weFill) 
  p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-04-10 00:00:00"),
                    xmax = lubridate::as_datetime("2020-04-13 23:59:59"), # Easter
                    ymin = yMin, ymax = yMax,
                    alpha = localParams$weAlpha, fill = localParams$weFill)
  p <- p + annotate("text", x = lubridate::as_datetime("2020-04-10 00:00:00"),
                    y = yMax*localParams$labelPos,
                    label = "Easter") # Easter
  p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-04-18 00:00:00"),
                    xmax = lubridate::as_datetime("2020-04-19 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = localParams$weAlpha, fill = localParams$weFill)
    p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-04-25 00:00:00"),
                    xmax = lubridate::as_datetime("2020-04-26 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = localParams$weAlpha, fill = localParams$weFill)
  return(p)
}
```

\newpage

# About

## Citation

```{r citation, child=gcParams$citation}
```

## Report circulation

 * Public – this report is intended for publication.

## Code

All code used to create this report is available from:

 * https://github.com/CfSOtago/gridCarbon

## License {#license}

```{r ccby license, child=gcParams$licenseCCBY}
```

## History

```{r history, child=gcParams$history}
```
 * this [report's edit history](https://github.com/CfSOtago/gridCarbon/commits/master/dataAnalysis/)
 
## Support

```{r generic support, child=gcParams$support}
```
 * The European Union via [SPATIALEC](http://www.energy.soton.ac.uk/tag/spatialec/), a Marie Skłodowska-Curie [Global Fellowship](https://ec.europa.eu/research/mariecurieactions/actions/individual-fellowships_en) based at the University of Otago’s [Centre for Sustainability](http://www.otago.ac.nz/centre-sustainability/staff/otago673896.html) (2017-2019) & the University of Southampton’s [Sustainable Energy Research Group](http://www.otago.ac.nz/centre-sustainability/staff/otago673896.html) (2019-2020) (Anderson)
 
\newpage

# Introduction

Building on [@staffell_measuring_2017] and [@khan_analysis_2018], we are interested in GHG emissions from UK electricity generation over time. We are especially interested in how this might change during the UK covid-19 lockdown period (from `r localParams$lockDownStart`).

Fortunately the UK Electricity System Operator publishes half-hourly generation data which includes both power generation (and thus 'demand') by fuels and also includes a per-kWh carbon intensity for the enrgy produced per half-hour. We use this data to explore the following research questions:

 * To what extent has electricty demand shown deviation from 'normal' demand patterns during the lockdown period?

 * Has the composition of fuel sources supplying electriicty changed during this period?

 * Has the lockdown changed greenhouse-gas emissions associated with electriicty generation?
 
# Data

## Grid generation data

Essentially 'grid' generation from major power stations of various kinds. Data downloaded from ` https://data.nationalgrideso.com/carbon-intensity1/historic-generation-mix/r/historic_gb_generation_mix` and pre-processed.

```{r testGrid}
h <- head(gridGenDT[, .(DATETIME, year, rDateTimeUTC, GENERATION, CARBON_INTENSITY)])

kableExtra::kable(h, caption = "Grid gen data (first 6 rows)") %>%
  kable_styling()
```

```{r prepData}
# re-use the method from the airQual analysis to align the years
# kludgy but works

# this is such a kludge
gridGenDT[, obsDate := lubridate::date(rDateTimeUTC)]
gridGenDT[, decimalDate := lubridate::decimal_date(obsDate)] # gives year.% of year

# set to 2020 'dates'
gridGenDT[, date2020 := lubridate::as_date(lubridate::date_decimal(2020 + (decimalDate - year)))] # sets 'year' portion to 2020 so the lockdown annotation works
gridGenDT[, day2020 := lubridate::wday(date2020, label = TRUE)] # 

# 2020 Jan 1st = Weds
dt2020 <- gridGenDT[year == 2020] 
dt2020[, dateFixed := obsDate] # no need to change
dt2020[, wkdayFixed := lubridate::wday(dateFixed,label = TRUE)]
# table(dt2020$origDoW, dt2020$fixedDoW)
# head(dt2020[origDoW != fixedDoW])

# shift to the closest aligning day
# 2019 Jan 1st = Tues
dt2019 <- gridGenDT[year == 2019] 
dt2019[, dateFixed := date2020 -1]
dt2019[, wkdayFixed := lubridate::wday(dateFixed,label = TRUE)]
# table(dt2019$origDoW, dt2019$fixedDoW)
# head(dt2019[origDoW != fixedDoW])

# 2018 Jan 1st = Mon
dt2018 <- gridGenDT[year == 2018] 
dt2018[, dateFixed := date2020 - 2]
dt2018[, wkdayFixed := lubridate::wday(dateFixed,label = TRUE)]
# table(dt2018$origDoW, dt2018$fixedDoW)
# head(dt2018[origDoW != fixedDoW])

# 2017 Jan 1st = Sat
dt2017 <- gridGenDT[year == 2017] 
dt2017[, dateFixed := date2020 - 3]
dt2017[, wkdayFixed := lubridate::wday(dateFixed,label = TRUE)]
# table(dt2017$origDoW, dt2017$fixedDoW)
# head(dt2017[origDoW != fixedDoW])

fixedDT <- rbind(dt2017, dt2018, dt2019, dt2020) # leave out 2016 for now

fixedDT[, dateFixed := lubridate::as_date(dateFixed)]
fixedDT[, wkdayFixed := lubridate::wday(dateFixed,label = TRUE)]


fixedDT[, compareYear := ifelse(year == 2020, "2020",
                              "2017-2019")
        ]

fixedDT[, wkdayObs := lubridate::wday(obsDate, label = TRUE, )]

t <- fixedDT[, .(meanHalfHourlyMW = mean(GENERATION),
                 meanCI = mean(CARBON_INTENSITY),
                 nObs = .N), keyby = .(year)]

kableExtra::kable(t, caption = "Mean half hourly power (MW) and carbon intensity (CO2e) by year - note that 2020 is incomplete") %>%
  kable_styling()

```

## Embedded generation data

Essentially 'non-grid' generation from solar photovoltaic and small scale wind which is 'embedded' - i.e. non-grid connected as it is connected 'downstream' of the grid exit points. We are not entirely sure if this is accounted for in the grid dataset or not.

> We have not yet found a source of this data.

> For now embedded generation data is probably _not_ included in the following analysis but we would expect it to depress grid demand when the sun is shining and the wind is blowing.

# Analysis

In this section we analyse changes in electricity demand during the UK Covid-19 lockdown via analysis of the generation data. 

## Deviation from 'normal'

Several [articles](https://theconversation.com/we-analysed-electricity-demand-and-found-coronavirus-has-turned-weekdays-into-weekends-134606?utm_source=twitter&utm_medium=bylinetwitterbutton) and [analyses](https://twitter.com/DrIAGWilson/status/1255100828781883394) have suggested that demand (and thus generation) patterns have shifted so that [weekdays have become more like weekends](http://www.ukerc.ac.uk/news/covid-lockdown-electricity-demand.html).

Figure \@ref(fig:recentHalfHourlyGW) shows total half-hourly generation since `r localParams$recentCutDate`. Overall generation has fallen as we would expect given the season (less heating and lighting required) and weekdays are indeed less easy to distinguish from weekends.

```{r recentHalfHourlyGW, fig.cap="Half-hourly generation, UK (recent)"}
recentDT <- fixedDT[obsDate > localParams$recentCutDate]

p <- ggplot2::ggplot(recentDT, aes(x = rDateTimeUTC, 
                                   y = GENERATION/1000,
                                   colour = wkdayObs)) +
  geom_point() +
  scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(caption = paste0(localParams$lockdownCap, localParams$weekendCap,
                        "\n", localParams$gamCap),
       x = "Time",
       y = "Total generation (GW)") +
  theme(legend.position = "bottom") + 
  geom_smooth(aes(colour = NULL)) +
  scale_color_viridis_d(name = "Day of the week") +
  guides(colour=guide_legend(nrow=2))

# final plot - adds annotations
yMin <- min(recentDT$GENERATION/1000)
yMax <- max(recentDT$GENERATION/1000)

p <- addLockdownDateTime(p, yMin, yMax)
addWeekendsDateTime(p,yMin, yMax) 

```

Figure \@ref(fig:recentHalfHourlyGWProfiles) shows the daily generation profiles over time for each day of the week. Clearly the shapes are both reducing in magnitude (seasonal and lockdown effects) and also converging in shape.

```{r recentHalfHourlyGWProfiles, fig.cap="Half-hourly generation, UK (recent)"}
recentDT[, rTime:=hms::as_hms(rDateTimeUTC)]

p <- ggplot2::ggplot(recentDT, aes(x = rTime, 
                                   y = GENERATION/1000,
                                   colour = obsDate)) +
  geom_point() +
  #scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(x = "Time",
       y = "Total generation (GW)") +
  facet_wrap(. ~ wkdayObs)

  p +
    guides(colour=guide_legend(title="Date"))
```

Figure \@ref(fig:recentHalfHourlyCIProfiles) shows the daily carbon intensity profiles over time for each day of the week. As above, trends are much less clear.

```{r recentHalfHourlyCIProfiles, fig.cap="Half-hourly generation, UK (recent)"}
p <- ggplot2::ggplot(recentDT, aes(x = rTime, 
                                   y = CARBON_INTENSITY,
                                   colour = obsDate)) +
  geom_point() +
  #scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(x = "Time",
       y = "Carbon intensity (Kg CO2 kWh)") +
  facet_wrap(. ~ wkdayObs)

  p +
    guides(colour=guide_legend(title="Date"))
```

Figure \@ref(fig:recentHalfHourlyCI) shows half-hourly carbon intensity since `r localParams$recentCutDate`. As we might expect this is much more variable largely due to the contribution made by wind generation.

```{r recentHalfHourlyCI, fig.cap="Half-hourly carbon intensity, UK (recent)"}

p <- ggplot2::ggplot(recentDT, aes(x = rDateTimeUTC, 
                                   y = CARBON_INTENSITY,
                                   colour = wkdayObs)) +
  geom_point() +
  scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(caption = paste0(localParams$lockdownCap, localParams$weekendCap,
                        "\n", localParams$gamCap),
       x = "Time",
       y = "Carbon intensity (CO2e/kWh)") +
  theme(legend.position = "bottom") + 
  geom_smooth(aes(colour = NULL)) +
  scale_color_viridis_d(name = "Day of the week") +
  guides(colour=guide_legend(nrow=2))

# final plot - adds annotations
yMin <- min(recentDT$CARBON_INTENSITY)
yMax <- max(recentDT$CARBON_INTENSITY)

p <- addLockdownDateTime(p, yMin, yMax)
addWeekendsDateTime(p,yMin, yMax) 

```

Figure \@ref(fig:compareDaysGW) shows the most recent mean half-hourly GW compared to the same day in previous years. We have shifted the dates for the comparison years to ensure that weekdays and weekends line up. Note that this plot shows daily means with no indications of variance. Visible differences are therefore purely indicative at this stage. Nevertheless it is clear that 2020 is a different generation shape to the average of the previous years. Lockdown has clearly amplified the sesonal trend.

> Beware temperature differences

```{r compareDaysGW, fig.cap="Comparative daily mean half-hour generation levels 2020 vs 2017-2019"}
plotDT <- fixedDT[dateFixed <= lubridate::today() & 
                  dateFixed >= localParams$comparePlotCut, # otherwise we get the whole year 
                .(meanGen = mean(GENERATION),
                  nObs = .N,
                  meanCI = mean(CARBON_INTENSITY)
                  ),
                keyby = .(dateFixed, wkdayFixed, compareYear)]

# reduce the shape numbers
plotDT[, weekDay := ifelse(wkdayFixed == "Sat" |
                             wkdayFixed == "Sun", "Weekend", "Weekday")]

# final plot - adds annotations
yMin <- min(plotDT$meanGen/1000)
yMax <- max(plotDT$meanGen/1000)

p <- ggplot2::ggplot(plotDT, aes(x = dateFixed, 
                                   y = meanGen/1000,
                                   colour = compareYear,
                                 shape = weekDay)) +
  geom_point() +
  scale_x_date(date_breaks = "7 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(caption = paste0(localParams$lockdownCap, localParams$weekendCap,
                        "\n", localParams$gamCap),
       x = "Date",
       y = "Mean half hourly generation (GW)") +
  theme(legend.position = "bottom") + 
  geom_smooth(aes(shape = NULL)) + # will get a smooth line per year not per day
  scale_color_viridis_d(name = "Period") +
  scale_shape_discrete(name = "Weekday") +
  guides(colour=guide_legend(nrow=2)) +
  guides(shape=guide_legend(nrow=2))
  
p <- addLockdownDate(p, yMin, yMax)

addWeekendsDate(p, yMin, yMax)

```


# Summary (to date)

# Annexes

## Grid generation data

```{r skimGrid}
skimr::skim(gridGenDT)
```

## Conversion factors


# Runtime

```{r check runtime, include=FALSE}
t <- proc.time() - startTime
elapsed <- t[[3]]
```

Analysis completed in `r round(elapsed,2)` seconds ( `r round(elapsed/60,2)` minutes) using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`.

# R environment

## R packages used

 * base R [@baseR]
 * bookdown [@bookdown]
 * data.table [@data.table]
 * drake [@drake]
 * ggplot2 [@ggplot2]
 * kableExtra [@kableExtra]
 * knitr [@knitr]
 * lubridate [@lubridate]
 * rmarkdown [@rmarkdown]

## Session info

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
