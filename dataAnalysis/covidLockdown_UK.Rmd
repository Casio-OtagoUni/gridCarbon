---
params:
  subtitle: ""
  title: ""
  authors: ""
title: '`r params$title`'
subtitle: '`r params$subtitle`'
author: '`r params$authors`'
date: 'Last run at: `r Sys.time()`'
output:
  bookdown::html_document2:
    fig_caption: yes
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: TRUE
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: yes
  bookdown::word_document2:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
    fig_width: 5
always_allow_html: yes
bibliography: '`r paste0(here::here(), "/bibliography.bib")`'
---

```{r knitrSetup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo
```


```{r codeSetup, include=FALSE}
# Set start time ----
startTime <- proc.time()
# Local parameters ----
b2Kb <- 1024 #http://whatsabyte.com/P1/byteconverter.htm
b2Mb <- 1048576
plotLoc <- paste0(gcParams$repoLoc, "/docs/plots/") # where to put the plots

library(gridCarbon)
# Packages used in the report ----
rmdLibs <- c("ggplot2", # plots
             "hms",
          "kableExtra", # fancy tables
          "lubridate",
          "viridis"
          )
gridCarbon::loadLibraries(rmdLibs)

# Local parameters ----
localParams$recentCutDate <- as.Date("2020-03-01")

localParams$comparePlotCutDate <- as.Date("2020-02-01")

localParams$gamCap <- "Trend line = Generalized additive model (gam) with integrated smoothness estimation"
localParams$lockdownCap <- "\nColoured rectangles = UK covid lockdown periods to date"
localParams$weekendCap <- "\nShaded rectangle = weekends"

# Local functions ----

```

\newpage

# About

## Citation

```{r citation, child=gcParams$citation}
```

## Report circulation

 * Public – this report is intended for publication.

## Code

All code used to create this report is available from:

 * https://github.com/CfSOtago/gridCarbon

## License {#license}

```{r ccby license, child=gcParams$licenseCCBY}
```

## History

```{r history, child=gcParams$history}
```
 * this [report's edit history](https://github.com/CfSOtago/gridCarbon/commits/master/dataAnalysis/)
 
## Support

```{r generic support, child=gcParams$support}
```
 * The European Union via [SPATIALEC](http://www.energy.soton.ac.uk/tag/spatialec/), a Marie Skłodowska-Curie [Global Fellowship](https://ec.europa.eu/research/mariecurieactions/actions/individual-fellowships_en) based at the University of Otago’s [Centre for Sustainability](http://www.otago.ac.nz/centre-sustainability/staff/otago673896.html) (2017-2019) & the University of Southampton’s [Sustainable Energy Research Group](http://www.otago.ac.nz/centre-sustainability/staff/otago673896.html) (2019-2020) (Anderson)
 
\newpage

# Introduction

Building on [@staffell_measuring_2017] and [@khan_analysis_2018], we are interested in GHG emissions from UK electricity generation over time. We are especially interested in how this might change during the UK covid-19 lockdown period (from `r localParams$lockDownStart`).

Fortunately the UK Electricity System Operator publishes [half-hourly generation data](https://data.nationalgrideso.com/carbon-intensity1/historic-generation-mix/r/historic_gb_generation_mix) which includes both power generation (and thus 'demand') by fuels and also includes a per-kWh [carbon intensity](https://carbonintensity.org.uk/) for the electricity produced per half-hour. We use this data to explore the following research questions:

 * To what extent has electricty demand shown deviation from 'normal' demand patterns during the lockdown period?

 * Has the composition of fuel sources supplying electriicty changed during this period?

 * Has the lockdown changed greenhouse-gas emissions associated with electriicty generation?
 
# Data

## Grid generation data

Essentially 'grid' generation from major power stations of various kinds. Data downloaded from ` https://data.nationalgrideso.com/carbon-intensity1/historic-generation-mix/r/historic_gb_generation_mix` and pre-processed.

```{r testGrid}
h <- head(gridGenDT[, .(DATETIME, year, rDateTimeUTC, GENERATION, CARBON_INTENSITY)])

kableExtra::kable(h, caption = "Grid gen data (first 6 rows)") %>%
  kable_styling()
```

```{r prepData}
fixedDT <- drake::readd(fixedGenData)
t <- fixedDT[, .(meanHalfHourlyMW = mean(GENERATION),
                 meanCI = mean(CARBON_INTENSITY),
                 nObs = .N), keyby = .(year)]

kableExtra::kable(t, caption = "Mean half hourly power (MW) and carbon intensity (CO2e) by year - note that 2020 is incomplete") %>%
  kable_styling()

```

### Units {#units}

Note that according to the dataset [source](https://data.nationalgrideso.com/carbon-intensity1/historic-generation-mix/r/historic_gb_generation_mix):

 * "Data points are either MW or %". This may mean mean MW over the half hour or it may mean MWh per half-hour. It is unclear. The % refers to the fuel mix. Which one could easily calculate from the MW values. But anyway...
 * carbon intensity is helpfully described as _"The carbon intensity of electricity is a measure of how much Carbon dioxide emissions are produced per kilowatt hour of electricity consumed."_. However we assume it is gCO2e/kWh - based on https://carbonintensity.org.uk/ 
 
## Embedded generation data

Essentially 'non-grid' generation from solar photovoltaic and small scale wind which is 'embedded' - i.e. non-grid connected as it is connected 'downstream' of the grid exit points. We are not entirely sure if this is accounted for in the grid dataset or not.

> We have not yet found a source of this data (if we even need it).

> For now embedded generation data is probably _not_ included in the following analysis but we would expect it to depress grid demand when there is greatest insolation (middle of the day, obvs) and wind (largely random in the UK?).

# Analysis

In this section we analyse changes in electricity demand and associated carbon emissions during the UK Covid-19 lockdown via analysis of the generation data. 

## Generation: Analysing deviation from 'normal'

Several [articles](https://theconversation.com/we-analysed-electricity-demand-and-found-coronavirus-has-turned-weekdays-into-weekends-134606?utm_source=twitter&utm_medium=bylinetwitterbutton) and [analyses](https://twitter.com/DrIAGWilson/status/1255100828781883394) have suggested that demand (and thus generation) patterns have shifted so that [weekdays have become more like weekends](http://www.ukerc.ac.uk/news/covid-lockdown-electricity-demand.html).

### Half hourly patterns
Figure \@ref(fig:recentHalfHourlyGW) shows total half-hourly generation since `r localParams$recentCutDate`. Overall generation has fallen as we would expect given the season (less heating and lighting required) and weekdays are indeed less easy to distinguish from weekends.

```{r recentHalfHourlyGW, fig.cap="Half-hourly generation, UK (recent)"}
recentDT <- fixedDT[obsDate > localParams$recentCutDate]

p <- ggplot2::ggplot(recentDT, aes(x = rDateTimeUTC, 
                                   y = GENERATION/1000,
                                   colour = wkdayObs)) +
  geom_point() +
  scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(caption = paste0(localParams$lockdownCap, localParams$weekendCap,
                        "\n", localParams$gamCap),
       x = "Time",
       y = "Total generation (GW)") +
  theme(legend.position = "bottom") + 
  geom_smooth(aes(colour = NULL)) +
  scale_color_viridis_d(name = "Day of the week") +
  guides(colour=guide_legend(nrow=2))

# final plot - adds annotations
yMin <- min(recentDT$GENERATION/1000)
yMax <- max(recentDT$GENERATION/1000)

p <- addLockdownRect(p, 
                     from = gcParams$UKlockDownStartDateTime, 
                     to = gcParams$UKlockDownEndDateTime, 
                     label = "Phase 1", yMin, yMax)
addWeekendRectsDateTime(p, yMin, yMax) 

```

Figure \@ref(fig:recentHalfHourlyGWProfiles) shows the daily generation profiles over time for each day of the week. Clearly the shapes are both reducing in magnitude (seasonal and lockdown effects) and also converging in shape.

```{r recentHalfHourlyGWProfiles, fig.cap="Half-hourly generation, UK (recent)"}
recentDT[, rTime:=hms::as_hms(rDateTimeUTC)]

p <- ggplot2::ggplot(recentDT, aes(x = rTime, 
                                   y = GENERATION/1000,
                                   colour = obsDate)) +
  geom_point() +
  #scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(x = "Time",
       y = "Total generation (GW)") +
  facet_wrap(. ~ wkdayObs)

  p +
    guides(colour=guide_legend(title="Date"))
```

### Daily patterns

Figure \@ref(fig:compareDaysGW) shows the most recent mean half-hourly GW compared to the same day in previous years. We have shifted the dates for the comparison years to ensure that weekdays and weekends line up. Note that this plot shows daily means with no indications of variance. Visible differences are therefore purely indicative at this stage. Nevertheless it is clear that 2020 is a different generation shape to the average of the previous years. Lockdown has clearly amplified the sesonal trend.

> Beware temperature differences

```{r compareDaysGW, fig.cap="Comparative daily mean half-hour generation levels 2020 vs 2017-2019"}
plotDT <- fixedDT[dateFixed <= lubridate::today() & 
                  dateFixed >= localParams$comparePlotCut, # otherwise we get the whole year 
                .(meanGen = mean(GENERATION),
                  nObs = .N,
                  meanCI = mean(CARBON_INTENSITY)
                  ),
                keyby = .(dateFixed, wkdayFixed, compareYear)]

# reduce the shape numbers
plotDT[, weekDay := ifelse(wkdayFixed == "Sat" |
                             wkdayFixed == "Sun", "Weekend", "Weekday")]

# final plot - adds annotations
yMin <- min(plotDT$meanGen/1000)
yMax <- max(plotDT$meanGen/1000)

p <- ggplot2::ggplot(plotDT, aes(x = dateFixed, 
                                   y = meanGen/1000,
                                   colour = compareYear,
                                 shape = weekDay)) +
  geom_point() +
  scale_x_date(date_breaks = "7 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(caption = paste0(localParams$lockdownCap, localParams$weekendCap,
                        "\n", localParams$gamCap),
       x = "Date",
       y = "Mean half hourly generation (GW)") +
  theme(legend.position = "bottom") + 
  geom_smooth(aes(shape = NULL)) + # will get a smooth line per year not per day
  scale_color_viridis_d(name = "Period") +
  scale_shape_discrete(name = "Weekday") +
  guides(colour=guide_legend(nrow=2)) +
  guides(shape=guide_legend(nrow=2))
  
p <- addLockdownRect(p, from = gcParams$UKlockDownStartDate, to = gcParams$UKlockDownEndDate, 
                     label = "Phase 1", yMin, yMax)

addWeekendRectsDate(p, yMin, yMax)

```

Figure \@ref(fig:compareDaysGWpc) shows the percentage difference between the mean half-hourly generation per day in 2020 and the 2017-2019 average for the same day. As we can see 2020 was already slightly lower than previous years but there appears to be a substantial lockdown effect especially on weekdays as we would expect.

```{r compareDaysGWpc, fig.cap="Percentage difference in mean generation levels 2020 vs 2017-2019"}

testDate <- localParams$comparePlotCut
#testDate <- as.Date("2020-03-21")
baseDT <- fixedDT[compareYear == "2017-2019", .(baseMean = mean(GENERATION)), 
               keyby = .(dateFixed, wkdayFixed, compareYear)]
testDT <- fixedDT[compareYear == "2020", .(testMean = mean(GENERATION)), 
               keyby = .(dateFixed, wkdayFixed, compareYear)]
  
setkey(baseDT, dateFixed, wkdayFixed)
setkey(baseDT, dateFixed, wkdayFixed)
  
plotDT <- baseDT[testDT] # auto drops non matches to 2020
plotDT[, pcDiffMean := 100*(testMean - baseMean)/baseMean] # -ve value indicates lower
plotDT[, pos := ifelse(pcDiffMean > 0 , "Pos", "Neg")] # want to colour the line sections - how?
  # final plot - adds annotations
  # use means for consistency with comparison plots where we use WHO thresholds (means)
yMin <- min(plotDT$pcDiffMean)
print(paste0("Max drop %:", round(yMin)))
yMax <- max(plotDT$pcDiffMean)
print(paste0("Max increase %:", round(yMax)))
p <- ggplot2::ggplot(plotDT, aes(x = dateFixed, y = pcDiffMean 
                                   #color = pos, group=NA)
                                   )
                       ) +
    geom_step() +
    scale_x_date(date_breaks = "7 days", date_labels =  "%a %d %b")  +
    theme(axis.text.x=element_text(angle=90, hjust=1, size = 5)) +
    labs(x = "Date",
         y = "% difference 2020 vs 2017-2019",
         caption = paste0(localParams$lockdownCap, localParams$weekendCap)) +  
    theme(legend.position="bottom") +
    geom_hline(yintercept = 0, linetype = 3)
  
  p <- addLockdownRect(p, from = gcParams$UKlockDownStartDate, to = gcParams$UKlockDownEndDate, 
                     label = "Phase 1", yMin, yMax)
  addWeekendRectsDate(p, yMin, yMax)
```

### Weekly patterns

## Carbon: Analysing deviation from 'normal'

There are two aspects to this. The first is `carbon intensity` which is driven by the mix of fuels being used to generate electricity at any given time. The second is the total greenhouse gasses emitted which is, obviously, the intensity * the volume. Given the slight uncertainty over units (see Section \@ref(units)) we assume this is `GENERATION` * `CARBON_INTENSITY`.

Clearly the first of these is driven by the mix of fuels and in the UK this reflects a complex mix of availability of renewables, price and interconnect as well as demand. To some extent there is no in priciple reason why carbon intensity should change during lockdown except that:

 * some electricity-usage practices may have shifted to (or indeed away from) periods which are likely to have high renewable availability;
 * soem electricity-usage pracrices may have shoiftewd away from the 'usual' morning and evening peak periods which are traditionally thought to require carbon intense peaking generation if sufficient pumped hydro is not available.

### Half-hourly patterns

Figure \@ref(fig:recentHalfHourlyCIProfiles) shows the daily carbon intensity profiles over time for each day of the week.

```{r recentHalfHourlyCIProfiles, fig.cap="Half-hourly generation, UK (recent)"}
p <- ggplot2::ggplot(recentDT, aes(x = rTime, 
                                   y = CARBON_INTENSITY,
                                   colour = obsDate)) +
  geom_point() +
  #scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(x = "Time",
       y = "Carbon intensity (Kg CO2 kWh)") +
  facet_wrap(. ~ wkdayObs)

  p +
    guides(colour=guide_legend(title="Date"))
```

Figure \@ref(fig:recentHalfHourlyCI) shows half-hourly carbon intensity since `r localParams$recentCutDate`. As we might expect this is much more variable largely due to the contribution made by wind generation.

```{r recentHalfHourlyCI, fig.cap="Half-hourly carbon intensity, UK (recent)"}

p <- ggplot2::ggplot(recentDT, aes(x = rDateTimeUTC, 
                                   y = CARBON_INTENSITY,
                                   colour = wkdayObs)) +
  geom_point() +
  scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(caption = paste0(localParams$lockdownCap, localParams$weekendCap,
                        "\n", localParams$gamCap),
       x = "Time",
       y = "Carbon intensity (CO2e/kWh)") +
  theme(legend.position = "bottom") + 
  geom_smooth(aes(colour = NULL)) +
  scale_color_viridis_d(name = "Day of the week") +
  guides(colour=guide_legend(nrow=2))

# final plot - adds annotations
yMin <- min(recentDT$CARBON_INTENSITY)
yMax <- max(recentDT$CARBON_INTENSITY)

p <- addLockdownRect(p, gcParams$UKlockDownStartDateTime, 
                     gcParams$UKlockDownEndDateTime, label = "Phase 1",
                     yMin, yMax)
addWeekendRectsDateTime(p,yMin, yMax) 

```

### Daily patterns

Figure \@ref(fig:compareDaysCIpc) shows the percentage difference between the mean half-hourly carbon intensity per day in 2020 and the 2017-2019 average for the same day. As expected, 2020 was already considerably lower than the average of previous years but this is not necessarily sustained through lockdown although the affects of weather on solar and wind availability need to be taken in to account.

```{r compareDaysCIpc, fig.cap="Percentage difference in mean carbon intensity levels 2020 vs 2017-2019"}

testDate <- localParams$comparePlotCut
#testDate <- as.Date("2020-03-21")
baseDT <- fixedDT[compareYear == "2017-2019", .(baseMean = mean(CARBON_INTENSITY)), 
               keyby = .(dateFixed, wkdayFixed, compareYear)]
testDT <- fixedDT[compareYear == "2020", .(testMean = mean(CARBON_INTENSITY)), 
               keyby = .(dateFixed, wkdayFixed, compareYear)]
  
setkey(baseDT, dateFixed, wkdayFixed)
setkey(baseDT, dateFixed, wkdayFixed)
  
plotDT <- baseDT[testDT] # auto drops non matches to 2020
plotDT[, pcDiffMean := 100*(testMean - baseMean)/baseMean] # -ve value indicates lower
plotDT[, pos := ifelse(pcDiffMean > 0 , "Pos", "Neg")] # want to colour the line sections - how?
  # final plot - adds annotations
  # use means for consistency with comparison plots where we use WHO thresholds (means)
yMin <- min(plotDT$pcDiffMean)
print(paste0("Max drop %:", round(yMin)))
yMax <- max(plotDT$pcDiffMean)
print(paste0("Max increase %:", round(yMax)))
p <- ggplot2::ggplot(plotDT, aes(x = dateFixed, y = pcDiffMean 
                                   #color = pos, group=NA)
                                   )
                       ) +
    geom_step() +
    scale_x_date(date_breaks = "7 days", date_labels =  "%a %d %b")  +
    theme(axis.text.x=element_text(angle=90, hjust=1, size = 5)) +
    labs(x = "Date",
         y = "% difference 2020 vs 2017-2019",
         caption = paste0(localParams$lockdownCap, localParams$weekendCap)) +  
    theme(legend.position="bottom") +
    geom_hline(yintercept = 0, linetype = 3)
  
p <- addLockdownRect(p, from = gcParams$UKlockDownStartDate, to = gcParams$UKlockDownEndDate, 
                     label = "Phase 1", yMin, yMax)
  addWeekendRectsDate(p, yMin, yMax) 
```

### Weekly patterns


# Summary (to date)

# Annexes

## Grid generation data

```{r skimGrid}
skimr::skim(gridGenDT)
```

## Conversion factors


# Runtime

```{r check runtime, include=FALSE}
t <- proc.time() - startTime
elapsed <- t[[3]]
```

Analysis completed in `r round(elapsed,2)` seconds ( `r round(elapsed/60,2)` minutes) using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`.

# R environment

## R packages used

 * base R [@baseR]
 * bookdown [@bookdown]
 * data.table [@data.table]
 * drake [@drake]
 * ggplot2 [@ggplot2]
 * kableExtra [@kableExtra]
 * knitr [@knitr]
 * lubridate [@lubridate]
 * rmarkdown [@rmarkdown]

## Session info

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
