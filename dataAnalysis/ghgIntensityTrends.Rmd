---
params:
  subtitle: ""
  title: ""
  authors: ""
title: '`r params$title`'
subtitle: '`r params$subtitle`'
author: '`r params$authors`'
date: 'Last run at: `r Sys.time()`'
output:
  bookdown::html_document2:
    fig_caption: yes
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: TRUE
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: yes
  bookdown::word_document2:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
    fig_width: 5
always_allow_html: yes
bibliography: '`r paste0(here::here(), "/bibliography.bib")`'
---

```{r knitrSetup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo
```


```{r codeSetup, include=FALSE}
# Set start time ----
startTime <- proc.time()
# Local parameters ----
b2Kb <- 1024 #http://whatsabyte.com/P1/byteconverter.htm
b2Mb <- 1048576
plotLoc <- paste0(gcParams$repoLoc, "/docs/plots/") # where to put the plots

library(gridCarbon)
# Packages used in the report ----
rmdLibs <- c("ggplot2", # plots
          "kableExtra", # fancy tables
          "lubridate"
          )
gridCarbon::loadLibraries(rmdLibs)

# Local parameters ----

# Local functions ----
```

\newpage

# About

## Citation

```{r citation, child=gcParams$citation}
```

## Report circulation

 * Public – this report is intended for publication following EECA approval.

## Code

All code used to create this report is available from:

 * https://github.com/CfSOtago/gridCarbon

## License {#license}

```{r ccby license, child=gcParams$licenseCCBY}
```

## History

```{r history, child=gcParams$history}
```
 * this [report's edit history](https://github.com/CfSOtago/gridCarbon/commits/master/dataAnalysis/)
 
## Support

```{r generic support, child=gcParams$support}
```
 * The European Union via [SPATIALEC](http://www.energy.soton.ac.uk/tag/spatialec/), a Marie Skłodowska-Curie [Global Fellowship](https://ec.europa.eu/research/mariecurieactions/actions/individual-fellowships_en) based at the University of Otago’s [Centre for Sustainability](http://www.otago.ac.nz/centre-sustainability/staff/otago673896.html) (2017-2019) & the University of Southampton’s [Sustainable Energy Research Group](http://www.otago.ac.nz/centre-sustainability/staff/otago673896.html) (2019-2020) (Anderson);
 * The Uniersity of Otago via a Centre for Sustainability Summer Scholarship (Lotte) and PhD Studentship (Dortans)
 
\newpage

# Introduction

Building on [@khan_analysis_2018], we are interested in GHG emissions from the NZ electricity generation over time. We are especially interested in how this might change during the NZ covid-19 lockdown period (`r localParams$lockDownStart` to `r localParams$lockDownEnd`).

# Load data

## Wholesale generation data

Essentially 'grid' generation from major power stations of various kinds. Data downloaded from `https://www.emi.ea.govt.nz/Wholesale/Datasets/Generation/Generation_MD/` and pre-processed.

```{r testGrid}
h <- head(allGridDT)

kableExtra::kable(h, caption = "Grid gen data (first 6 rows)") %>%
  kable_styling()
```

## Embedded generation data

Essentially 'non-grid' generation from solar photovoltaic and small scale wind. Data downloaded from `https://www.emi.ea.govt.nz/Wholesale/Datasets/Metered_data/Embedded_generation` and pre-processed.

```{r testEmbedded}
#h <- head(allEmbeddedDT)

#kableExtra::kable(h, caption = "Embedded gen data (first 6 rows)") %>%
 # kable_styling()
```

# General trends over time

# covid19 lockdown (March 2020)

```{r lockdownMethodology}

# 1. Select relevant years/months
  # -> What do we want to find out? 
   # Reduction in generation (this requires ex ante/post ante data)
   # Changes in the feed-in of embedded generation
   # Changes in GhG emissions

# 2. Aggregate data by fuel and time
# 3. Link GhG emissions to generation data
# 4. Output of tables/plots embedded in text

```

```{r lockdown1DataSelection}

#Selects Jan and Feb of 2020 as we do not have March data yet
selectDT <- allGridDT[month >= 1 & 
                      month <= 2 &
                      year == 2020]

#Building means by Fuel_Code, rDateTime, Time_Period, rMonth
shortDT <- selectDT[, meankWh := NA]
shortDT <- shortDT[, . (meankWh = mean(kWh)), keyby= .(Fuel_Code, rDateTime, Time_Period, rMonth)]

#Building a variable with total generation
#shortDT <- shortDT[, summeankWh := sum(meankWh), keyby = .(rDateTime, Time_Period)]

#Test
myPlot <- ggplot2::ggplot(shortDT, aes(x= rDateTime)) +
  geom_line(aes(y = meankWh, colour = Fuel_Code))+
  scale_color_manual(values = c('Hydro'='blue','Coal'='grey', 'Wind'='green', 'Wood'='brown', 'Diesel'='yellow', 'Gas'='purple', 'Geo'='red'))
myPlot
  
#By the looks of it I might have to do some data manipulation to have each Fuel_Code in a seperate column...I know how to do this :) 
shortDT <- dcast(shortDT,
           rDateTime + Time_Period + rMonth  ~ Fuel_Code, 
           fun = mean, # won't do anything as we should just have 1 value?
           value.var = "meankWh")


#Test2
legend_title <- "Type of Fuel"
myPlot <- ggplot2::ggplot(shortDT, aes(x= rDateTime)) +
  geom_line(aes(y = Coal, colour = "Coal"))+
  geom_line(aes(y = Diesel, colour = "Diesel"))+
  geom_line(aes(y=Hydro, colour = "Hydro"))+
  scale_color_manual(legend_title, labels = c("Coal",
                                              "Diesel",
                                              "Hydro"), values = c("grey",
                                                                  "black",
                                                                  "blue")) 
  myPlot
  

  #Still does  not look right. Even when I sum Coal and Hydro kWh, Coal is much more which does not make sense. Perhaps the labeling in allGridDT is wrong???




```


# Annexes

## Wholesale generation data ('grid')

```{r skimGrid}
skimr::skim(allGridDT)
```

## Embedded generation data ('nongrid')

```{r skimNonGrid}
skimr::skim(allEmbeddedDT)
```

## Conversion factors


# Runtime

```{r check runtime, include=FALSE}
t <- proc.time() - startTime
elapsed <- t[[3]]
```

Analysis completed in `r round(elapsed,2)` seconds ( `r round(elapsed/60,2)` minutes) using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`.

# R environment

## R packages used

 * base R [@baseR]
 * bookdown [@bookdown]
 * data.table [@data.table]
 * ggplot2 [@ggplot2]
 * kableExtra [@kableExtra]
 * knitr [@knitr]
 * lubridate [@lubridate]
 * rmarkdown [@rmarkdown]

## Session info

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
