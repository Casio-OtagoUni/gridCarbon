---
params:
  subtitle: ""
  title: ""
  authors: ""
title: '`r params$title`'
subtitle: '`r params$subtitle`'
author: '`r params$authors`'
date: 'Last run at: `r Sys.time()`'
output:
  bookdown::html_document2:
    fig_caption: yes
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: TRUE
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: yes
  bookdown::word_document2:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
    fig_width: 5
always_allow_html: yes
bibliography: '`r paste0(here::here(), "/bibliography.bib")`'
---

```{r knitrSetup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo
```


```{r codeSetup, include=FALSE}
# Set start time ----
startTime <- proc.time()
# Local parameters ----
b2Kb <- 1024 #http://whatsabyte.com/P1/byteconverter.htm
b2Mb <- 1048576
plotLoc <- paste0(gcParams$repoLoc, "/docs/plots/") # where to put the plots

library(gridCarbon)
# Packages used in the report ----
rmdLibs <- c("ggplot2", # plots
          "kableExtra", # fancy tables
          "lubridate"
          )
gridCarbon::loadLibraries(rmdLibs)

# Local parameters ----

# Local functions ----
```

\newpage

# About

## Citation

```{r citation, child=gcParams$citation}
```

## Report circulation

 * Public – this report is intended for publication following EECA approval.

## Code

All code used to create this report is available from:

 * https://github.com/CfSOtago/gridCarbon

## License {#license}

```{r ccby license, child=gcParams$licenseCCBY}
```

## History

```{r history, child=gcParams$history}
```
 * this [report's edit history](https://github.com/CfSOtago/gridCarbon/commits/master/dataAnalysis/)
 
## Support

```{r generic support, child=gcParams$support}
```
 * The European Union via [SPATIALEC](http://www.energy.soton.ac.uk/tag/spatialec/), a Marie Skłodowska-Curie [Global Fellowship](https://ec.europa.eu/research/mariecurieactions/actions/individual-fellowships_en) based at the University of Otago’s [Centre for Sustainability](http://www.otago.ac.nz/centre-sustainability/staff/otago673896.html) (2017-2019) & the University of Southampton’s [Sustainable Energy Research Group](http://www.otago.ac.nz/centre-sustainability/staff/otago673896.html) (2019-2020) (Anderson);
 * The Uniersity of Otago via a Centre for Sustainability Summer Scholarship (Lotte) and PhD Studentship (Dortans)
 
\newpage

# Introduction

Building on [@khan_analysis_2018], we are interested in GHG emissions from the NZ electricity generation over time. We are especially interested in how this might change during the NZ covid-19 lockdown period (`r localParams$lockDownStart` to `r localParams$lockDownEnd`).

# Load data

## Wholesale generation data

Essentially 'grid' generation from major power stations of various kinds. Data downloaded from `https://www.emi.ea.govt.nz/Wholesale/Datasets/Generation/Generation_MD/` and pre-processed.

```{r testGrid}
h <- head(allGridDT)

kableExtra::kable(h, caption = "Grid gen data (first 6 rows)") %>%
  kable_styling()
```

## Embedded generation data

Essentially 'non-grid' generation from solar photovoltaic and small scale wind. Data downloaded from `https://www.emi.ea.govt.nz/Wholesale/Datasets/Metered_data/Embedded_generation` and pre-processed.

```{r headEmbedded}
h <- head(allEmbeddedDT)

kableExtra::kable(h, caption = "Embedded gen data (first 6 rows)") %>%
  kable_styling()
```


```{r testEmbedded}
allEmbeddedDT[, year := lubridate::year(rDate)]
st <- allEmbeddedDT[, .(sumkWh = sum(kWh, na.rm = TRUE),
                        nObs = .N), keyby = .(Flow_Direction, year)]

rt <- data.table::dcast(st, year ~ Flow_Direction,  value.var = c("sumkWh", "nObs"))

kableExtra::kable(rt, caption = "Mean kWh by flow direction") %>%
  kable_styling()
```

Not entirely sure what these codes mean yet. TBC

> For now embedded generation data is _not_ included in the following analysis.

# General trends over time

We use two different GHG emissions indicators:

 * % of total generation in a halfhour which was 'low emissions' where this is defined as wind + solar + hydro
 * Calculated CO2e emissions per half hour (not yet implemented)

Available fuels are shown in X by year for the data available.

```{r fuelsTab}
t <- with(allGridDT, table(year, Fuel_Code))

kableExtra::kable(t, caption = "Count of half hours in which fuel coded per year. Note that data for 2020 is incomplete") %>%
  kable_styling()
```

```{r codeData}
allGridDT[, lowEmissions := ifelse(Fuel_Code == "Hydro" |
                                  Fuel_Code == "Wind", "'No' emissions", "Emissions")]
allGridDT[, rDate := lubridate::as_date(rDateTime)]
allGridDT <- addNZSeason(allGridDT, date = "rDate") # add seasons

# check
t <- with(allGridDT, table(rMonth, season))
#t
```

# 2019 (4 seasons)

```{r select2019}
dt2019 <- allGridDT[year == 2019]
```

```{r select2019}
dt2019 <- allGridDT[year == 2019]
```


# January - April 2020

# covid19 lockdown (March 2020)

In this section we analyse the current developments in electricity generation during the Covid-19 level four alert. The level four alert came into effect on March 25 at 11.59pm as part of the fight agianst the novel Covid-19 virus. The minimum lockdown period is four weeks, ending on April 23. This period has wide-spread implications across New Zealand's economy and electriicty consumption, amongst other effects such as everyday life in general.

All non-essential busineeses are closed and staff is asked to work from home. This analysis aims to provide insights on developments in electriicty generation. Essential research questions company this research:

* To what extent has electricty generation shown deviation of 'normal' generation patterns during the level four alert?

* Has the composition of fuel sources supplying electriicty demand in New Zealand changed during the level four alert?

* Has the level four alert impacted greenhouse-gas emissions associated with electriicty generation?

```{r lockdownMethodology, eval=FALSE}

# 1. Select relevant years/months
  # -> What do we want to find out? 
   # Reduction in generation (this requires ex ante/post ante data)
   # Changes in the feed-in of embedded generation
   # Changes in GhG emissions

# 2. Aggregate data by fuel and time
# 3. Link GhG emissions to generation data
# 4. Output of tables/plots embedded in text

```

```{r lockdown1SelectData, include=FALSE}

#Selects Jan and Feb of 2020 as we do not have March data yet
selectDT <- allGridDT[month >= 1 & 
                      month <= 2 &
                      year == 2020]

#Building means by Fuel_Code, rDateTime, Time_Period, rMonth
shortDT <- selectDT[, . (meankWh = mean(kWh),
                         sumkWh = sum(kWh),
                        nObs = .N), # number of obs - will show you how rare coal is :-)
                    keyby= .(Fuel_Code, rDateTime, Time_Period, rMonth)]
#This won't build means by month - it will build them by rDateTime as rMonth is constant for each rDateTime


#This shows us how many obs there are for each Fuel_Code. There might be an easier way to do it?
x2 <- by(shortDT$nObs, shortDT$Fuel_Code, sum)
do.call(rbind,as.list(x2))# Clearly hydro dominates


#Put this into a table for visualisation
kableExtra::kable(head(x2), col.names = "nObs", caption = "Number of observations by fuel") %>%
                    kable_styling()


```
We extracted electricity generation data from /INSERT DATES/. Table \@ref(tab:lockdown1SelectData) shows the number of observations for each fuel type for the aforementioned dates. It becomes clear that Hydro was the most used fuel type, followed by Geothermal, Wind, Gas, Coal, and Diesel. 

```{r lockdowncalc}

#Let us try to avoid confusion with kWh and convert it to power MW....
shortDT <- shortDT[, meanMW := (meankWh*2)/1000]
shortDT <- shortDT[, sumMW := (sumkWh*2)/1000]




kableExtra::kable(head(shortDT), caption = "Example summary data") %>%
                    kable_styling()
```
Table \@ref(tab:lockdowncalc)



```{r test}

#Building a variable with total generation
# BA: Yes, this is a much better idea!
#shortDT <- shortDT[, summeankWh := sum(meankWh), keyby = .(rDateTime, Time_Period)]

#Test
myPlotMean <- ggplot2::ggplot(shortDT, aes(x= rDateTime)) +
  geom_line(aes(y = meankWh, colour = Fuel_Code))+
  scale_color_manual(values = c('Hydro'='blue','Coal'='grey', 'Wind'='green', 'Wood'='brown', 'Diesel'='yellow', 'Gas'='purple', 'Geo'='red'))
#myPlotMean



#Changing order in plot

shortDT$Fuel_Code <- factor(shortDT$Fuel_Code, levels = c("Hydro","Geo",
                                                    "Gas", "Wind", "Coal", "Wood", "Diesel"))

legend_title <- "Type of Fuel"
myPlotSum <- ggplot2::ggplot(shortDT, aes(x= rDateTime)) +
  geom_line(aes(y = sumMW, colour = Fuel_Code))+
  scale_color_manual(legend_title, values = c('Hydro'='blue','Coal'='grey', 'Wind'='green', 'Wood'='brown', 'Diesel'='yellow', 'Gas'='purple', 'Geo'='red'))+
  theme(axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour ="black"))+
  labs(x='Time', y='Power (MW)') 
myPlotSum







# give it a new name as we've dcast it
recastDT <- dcast(shortDT,
           rDateTime + Time_Period + rMonth  ~ Fuel_Code, 
           fun = mean, # won't do anything as we should just have 1 value?
           value.var = "meankWh")


#Test2
legend_title <- "Type of Fuel"
myPlot <- ggplot2::ggplot(recastDT, aes(x= rDateTime)) +
  geom_line(aes(y = Coal, colour = "Coal"))+
  geom_line(aes(y = Diesel, colour = "Diesel"))+
  geom_line(aes(y=Hydro, colour = "Hydro"))+
  scale_color_manual(legend_title, labels = c("Coal",
                                              "Diesel",
                                              "Hydro"), values = c("grey",
                                                                  "black",
                                                                  "blue")) 
  myPlot
  

  #Still does  not look right. Even when I sum Coal and Hydro kWh, Coal is much more which does not make sense. Perhaps the labeling in allGridDT is wrong???

# BA: No the labels are right, the problem is the mean is only calculated over half-hours which have generation. So all the half-hours where coal = 0 are not included. In other words what you have found is that when coal is used, it produces a lot of MWh. But it is not used very often. So the 'mean in use' is high but you will find the sum of half hourly kWh is low. If you look at the nObs column I have introduced to shortDT you can see this. 
  
# Do not sum the mean kWh - the mean will have captured the 'high' coal output. In general one should never sum a mean unless you know how many observations have contributed to each mean...


```
```{r usefulCode}
#\@ref(fig:wattageContributionPeak1Plot)
#fig.cap="Percentage contribution to peak demand (17:00-21:00) in 2015"

#\@ref(tab:averageAtPeak)


```

# Annexes

## Wholesale generation data ('grid')

```{r skimGrid}
skimr::skim(allGridDT)
```

## Embedded generation data ('nongrid')

```{r skimNonGrid}
skimr::skim(allEmbeddedDT)
```

## Conversion factors


# Runtime

```{r check runtime, include=FALSE}
t <- proc.time() - startTime
elapsed <- t[[3]]
```

Analysis completed in `r round(elapsed,2)` seconds ( `r round(elapsed/60,2)` minutes) using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`.

# R environment

## R packages used

 * base R [@baseR]
 * bookdown [@bookdown]
 * data.table [@data.table]
 * ggplot2 [@ggplot2]
 * kableExtra [@kableExtra]
 * knitr [@knitr]
 * lubridate [@lubridate]
 * rmarkdown [@rmarkdown]

## Session info

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
