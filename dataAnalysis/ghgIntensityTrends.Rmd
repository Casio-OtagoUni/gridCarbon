---
params:
  subtitle: ""
  title: ""
  authors: ""
title: '`r params$title`'
subtitle: '`r params$subtitle`'
author: '`r params$authors`'
date: 'Last run at: `r Sys.time()`'
output:
  bookdown::html_document2:
    fig_caption: yes
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: TRUE
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: yes
  bookdown::word_document2:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
    fig_width: 5
always_allow_html: yes
bibliography: '`r paste0(here::here(), "/bibliography.bib")`'
---

```{r knitrSetup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo
```


```{r codeSetup, include=FALSE}
# Set start time ----
startTime <- proc.time()
# Local parameters ----
b2Kb <- 1024 #http://whatsabyte.com/P1/byteconverter.htm
b2Mb <- 1048576
plotLoc <- paste0(gcParams$repoLoc, "/docs/plots/") # where to put the plots

library(gridCarbon)
# Packages used in the report ----
rmdLibs <- c("ggplot2", # plots
          "kableExtra", # fancy tables
          "lubridate"
          )
gridCarbon::loadLibraries(rmdLibs)

# Local parameters ----

# Local functions ----
```

\newpage

# About

## Citation

```{r citation, child=gcParams$citation}
```

## Report circulation

 * Public – this report is intended for publication following EECA approval.

## Code

All code used to create this report is available from:

 * https://github.com/CfSOtago/gridCarbon

## License {#license}

```{r ccby license, child=gcParams$licenseCCBY}
```

## History

```{r history, child=gcParams$history}
```
 * this [report's edit history](https://github.com/CfSOtago/gridCarbon/commits/master/dataAnalysis/)
 
## Support

```{r generic support, child=gcParams$support}
```
 * The European Union via [SPATIALEC](http://www.energy.soton.ac.uk/tag/spatialec/), a Marie Skłodowska-Curie [Global Fellowship](https://ec.europa.eu/research/mariecurieactions/actions/individual-fellowships_en) based at the University of Otago’s [Centre for Sustainability](http://www.otago.ac.nz/centre-sustainability/staff/otago673896.html) (2017-2019) & the University of Southampton’s [Sustainable Energy Research Group](http://www.otago.ac.nz/centre-sustainability/staff/otago673896.html) (2019-2020) (Anderson);
 * The Uniersity of Otago via a Centre for Sustainability Summer Scholarship (Lotte) and PhD Studentship (Dortans)
 
\newpage

# Introduction

Building on [@khan_analysis_2018], we are interested in GHG emissions from the NZ electricity generation over time.

# Data

## Wholesale generation data

Essentially 'grid' generation from major power stations of various kinds. Data downloaded from `https://www.emi.ea.govt.nz/Wholesale/Datasets/Generation/Generation_MD/` and pre-processed.

```{r testGrid}
h <- head(allGridDT)

kableExtra::kable(h, caption = "Grid gen data (first 6 rows)") %>%
  kable_styling()
```

## Embedded generation data

Essentially 'non-grid' generation from solar photovoltaic and small scale wind which is 'embedded' - i.e. non-grid connected as it is connected 'downstream' of the grid exit points (GXP). Data downloaded from `https://www.emi.ea.govt.nz/Wholesale/Datasets/Metered_data/Embedded_generation` and pre-processed.

```{r headEmbedded}
h <- head(allEmbeddedDT)

kableExtra::kable(h, caption = "Embedded gen data (first 6 rows)") %>%
  kable_styling()
```


```{r testEmbedded}
allEmbeddedDT[, year := lubridate::year(rDate)]
st <- allEmbeddedDT[, .(sumkWh = sum(kWh, na.rm = TRUE),
                        nObs = .N), keyby = .(Flow_Direction, year)]

rt <- data.table::dcast(st, year ~ Flow_Direction,  value.var = c("sumkWh", "nObs"))

kableExtra::kable(rt, caption = "Mean kWh by flow direction") %>%
  kable_styling()
```

Not entirely sure what these codes mean yet. Limited [guidance](https://forum.emi.ea.govt.nz/thread/grid-export-and-embedded-generation-data) available? TBC

> For now embedded generation data is _not_ included in the following analysis.

# General trends over time

We use two different GHG emissions indicators:

 * % of total generation in a halfhour which was 'low emissions' where this is defined as wind + solar + hydro
 * Calculated CO2e emissions per half hour (not yet implemented)

Available fuels are shown in X by year for the data available.

```{r fuelsTab}
t <- with(allGridDT, table(year, Fuel_Code))

kableExtra::kable(t, caption = "Count of half hours in which fuel coded per year. Note that data for 2020 is incomplete") %>%
  kable_styling()
```

```{r codeData}
allGridDT <- allGridDT[!is.na(rDateTime) |
                        is.na(kWh)] # should remove DST break issues etc
allGridDT[, lowEmissions := ifelse(Fuel_Code == "Hydro" |
                                  Fuel_Code == "Wind", "'No' emissions", "Emissions")]
allGridDT[, rDate := lubridate::as_date(rDateTime)]
allGridDT <- addNZSeason(allGridDT, date = "rDate") # add seasons #Does not not work???

# check
t <- with(allGridDT, table(rMonth, season)) #Does not work based on previous uncomment
#t

```

## 2019 (4 seasons)

```{r select2019}
dt2019 <- allGridDT[year == 2019]

# check
st <- summary(dt2019$rDate)
```

Figure \@ref(fig:plotGWh) shows the total generation in GWh which is classified as 'no emissions'.

```{r plotGWh}
plotDT <- dt2019[!is.na(kWh), .(sumkWh = sum(kWh)), keyby = .(lowEmissions, rMonth)]

ggplot2::ggplot(plotDT, aes(x = rMonth, y = sumkWh/1000000, fill = lowEmissions)) +
  geom_col(position = "stack") +
  labs(y = "Total GWh",
       x = "Month",
       caption = "2019")
```

Figure \@ref(fig:plotProportionByMonth) shows the % of total generation in GWh which is classified as 'no emissions'.

```{r plotProportionByMonth}
# could dcast but this make it obvious what we are doing:

noE <- plotDT[lowEmissions %like% "No"]
noE[, sumkWhNoE := sumkWh]
noE$lowEmissions <- NULL
noE$sumkWh <- NULL
E <- plotDT[!(lowEmissions %like% "No")]
E[, sumkWhE := sumkWh]
E$lowEmissions <- NULL
E$sumkWh <- NULL
setkey(noE, rMonth)
setkey(E, rMonth)

wideDT <- noE[E]
wideDT[, pcNoE := sumkWhNoE/(sumkWhNoE+sumkWhE)]

ggplot2::ggplot(wideDT, aes(x = rMonth, y = 100*pcNoE)) +
  geom_col() +
  labs(y = "'no emissions' GWh as % of total",
       x = "Month",
       caption = "2019")

```

Figure \@ref(fig:plotProportionByDate) shows the % of total generation which is classified as 'no emissions' by time of day and date in 2019.

```{r plotProportionByDate}
plotDT <- dt2019[!is.na(kWh), .(sumkWh = sum(kWh)),
                    keyby = .(rTime, rDate, lowEmissions)]

# could dcast but this make it obvious what we are doing:
noE <- plotDT[lowEmissions %like% "No"]
noE[, sumkWhNoE := sumkWh]
noE$lowEmissions <- NULL
noE$sumkWh <- NULL
E <- plotDT[!(lowEmissions %like% "No")]
E[, sumkWhE := sumkWh]
E$lowEmissions <- NULL
E$sumkWh <- NULL
setkey(noE, rTime, rDate)
setkey(E, rTime, rDate)


wideDT <- noE[E]
wideDT[, pcNoE := sumkWhNoE/(sumkWhNoE+sumkWhE)]

ggplot2::ggplot(wideDT, aes(x = rDate, y = rTime, fill = pcNoE*100)) +
  geom_tile() +
  scale_fill_continuous("%", low = "red", high = "green") +
  labs(y = "Time of Day",
       x = "Month",
       caption = "% generation which is 'no emissions'\n2019")

```

Figure \@ref(fig:plotProportionByHalfHour) shows the % of total generation which is classified as 'no emissions' by half-hour in 2019.

```{r plotProportionByHalfHour}
plotDT <- dt2019[!is.na(kWh), .(sumkWh = sum(kWh)),
                    keyby = .(rDateTime, lowEmissions)]

# could dcast but this make it obvious what we are doing:
noE <- plotDT[lowEmissions %like% "No"]
noE[, sumkWhNoE := sumkWh]
noE$lowEmissions <- NULL
noE$sumkWh <- NULL
E <- plotDT[!(lowEmissions %like% "No")]
E[, sumkWhE := sumkWh]
E$lowEmissions <- NULL
E$sumkWh <- NULL
setkey(noE, rDateTime)
setkey(E, rDateTime)


wideDT <- noE[E]
wideDT[, pcNoE := sumkWhNoE/(sumkWhNoE+sumkWhE)]

ggplot2::ggplot(wideDT, aes(x = rDateTime, y = pcNoE*100)) +
  geom_line() +
  labs(y = "%",
       x = "Half hour",
       caption = "% generation which is 'no emissions'\n2019")

```

## 2009 - 2019

# Conclusions

# Annexes

## Wholesale generation data ('grid')

```{r skimGrid}
skimr::skim(allGridDT)
```

## Embedded generation data ('nongrid')

```{r skimNonGrid}
skimr::skim(allEmbeddedDT)
```

## Conversion factors


# Runtime

```{r check runtime, include=FALSE}
t <- proc.time() - startTime
elapsed <- t[[3]]
```

Analysis completed in `r round(elapsed,2)` seconds ( `r round(elapsed/60,2)` minutes) using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`.

# R environment

## R packages used

 * base R [@baseR]
 * bookdown [@bookdown]
 * data.table [@data.table]
 * ggplot2 [@ggplot2]
 * kableExtra [@kableExtra]
 * knitr [@knitr]
 * lubridate [@lubridate]
 * rmarkdown [@rmarkdown]

## Session info

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
